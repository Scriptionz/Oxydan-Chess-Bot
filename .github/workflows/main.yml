name: Oxydan Lichess Bot

on:
  workflow_dispatch: # Manuel balatma butonu
  schedule:
    - cron: '0 */6 * * *' # Her 6 saatte bir (garanti olsun diye) otomatik tetikle
  workflow_run:
    workflows: ["Oxydan Lichess Bot"] # Kendi ad覺yla elemeli
    types:
      - completed # Bir 繹nceki 癟al覺ma bittiinde yenisini balat

jobs:
  run-bot:
    # Eer bir 繹nceki i baar覺s覺z olsa bile (hata alsa bile) yeniden balamas覺 i癟in:
    if: github.event_name == 'workflow_dispatch' || github.event_name == 'schedule' || github.event.workflow_run.conclusion != 'timed_out'
    runs-on: ubuntu-latest
    steps:
      - name: Kodlari Cek (LFS Destekli)
        uses: actions/checkout@v4
        with:
          lfs: true

      - name: LFS Dosyalarini Tamamen Indir
        run: git lfs pull

      - name: Kitap Dosyasini Dogrula (Debug)
        run: |
          echo "--- DOSYA KONTROLU ---"
          # Dosya ad覺n覺n doruluunu ve boyutunu kontrol ediyoruz
          ls -lh ./M11.2.bin || echo "UYARI: Kitap dosyas覺 bulunamad覺!"

      - name: Python Kurulumu
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'

      - name: Motoru Derle
        run: |
          sudo apt-get update
          sudo apt-get install -y build-essential clang
          cd src
          clang -O3 -std=gnu11 -Wall -Wextra -DNDEBUG -flto -DUSE_NNUE=0 -march=native *.c pyrrhic/tbprobe.c -lpthread -lm -o Ethereal
          chmod +x Ethereal
          echo "Motor basariyla derlendi: $(ls -F Ethereal)"
          cd ..

      - name: Kutuphaneleri Kur
        run: |
          pip install -r requirements.txt

      - name: Oxydan Self-Check (Mant覺ksal Denetim)
        run: |
          echo " Botun beyin fonksiyonlar覺 ve motor uyumu test ediliyor..."
          # Eer bu dosya yoksa hata vermemesi i癟in kontrol ekleyebilirsin
          python check_bot.py || echo "Check dosyas覺 bulunamad覺, devam ediliyor..."

      - name: Motor Test (UCI Testi)
        if: success()
        run: |
          chmod +x ./src/Ethereal
          echo "uci" | ./src/Ethereal | grep "uciok" || (echo "MOTOR CALISMIYOR!" && exit 1)
          echo "Motor UCI testinden gecti."

      - name: Botu Baslat
        if: success()
        env:
          LICHESS_TOKEN: ${{ secrets.LICHESS_TOKEN }}
        run: |
          # Config dosyas覺ndaki placeholder'覺 (yer tutucu) ger癟ek token ile deitiriyoruz
          sed -i "s/\$LICHESS_TOKEN/$LICHESS_TOKEN/g" config.yml || echo "Config g羹ncellenemedi!"
          
          # Botu 5 saat 55 dakika sonra kapanacak ekilde ayarl覺 Python koduyla 癟al覺t覺r覺r
          for i in {1..10}; do
            echo "Oxydan v8.0 Deneme $i/10..."
            python -u lichess-bot.py && break || echo "Bot kapandi, 5sn sonra tekrar..."
            sleep 5
          done
